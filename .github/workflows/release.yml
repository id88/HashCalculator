name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Visual Studio
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Compile resource file
      run: rc /r HashCalculator.rc

    - name: Compile source files
      run: cl /c /EHsc /std:c++17 /DUNICODE /D_UNICODE /I. /W3 /O2 /GL HashCalculator.cpp MainWindow.cpp main.cpp

    - name: Link executable
      run: link /OUT:HashCalculator.exe /LTCG /OPT:REF /OPT:ICF HashCalculator.obj MainWindow.obj main.obj HashCalculator.res user32.lib gdi32.lib comctl32.lib advapi32.lib Shell32.lib

    - name: Calculate checksums
      shell: powershell
      run: |
        $hash = Get-FileHash -Path "HashCalculator.exe" -Algorithm SHA256
        $hash.Hash | Out-File -FilePath "HashCalculator.exe.sha256" -Encoding ASCII
        $md5 = Get-FileHash -Path "HashCalculator.exe" -Algorithm MD5
        $md5.Hash | Out-File -FilePath "HashCalculator.exe.md5" -Encoding ASCII
        
        # è¾“å‡ºæ ¡éªŒå’Œä¿¡æ¯
        Write-Host "SHA256: $($hash.Hash)"
        Write-Host "MD5: $($md5.Hash)"

    - name: Create release package
      shell: powershell
      run: |
        # è·å–ç‰ˆæœ¬å·
        $version = ${{ github.ref_name }}.Substring(1)  # ç§»é™¤ 'v' å‰ç¼€
        $exeFile = Get-Item "HashCalculator.exe"
        $fileSize = [math]::Round($exeFile.Length / 1KB, 2)
        $sha256 = Get-Content "HashCalculator.exe.sha256"
        $md5 = Get-Content "HashCalculator.exe.md5"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Path "release" -Force
        
        # å¤åˆ¶æ–‡ä»¶
        Copy-Item "HashCalculator.exe" -Destination "release/"
        Copy-Item "HashCalculator.exe.sha256" -Destination "release/"
        Copy-Item "HashCalculator.exe.md5" -Destination "release/"
        Copy-Item "README.md" -Destination "release/"
        Copy-Item "register.reg" -Destination "release/"
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        $releaseNotes = @'
# HashCalculator v{0} å‘å¸ƒè¯´æ˜

## ğŸ‰ æ–°ç‰ˆæœ¬ç‰¹æ€§

- æ–‡ä»¶å“ˆå¸Œè®¡ç®—å™¨ï¼Œæ”¯æŒMD5å’ŒSHA1ç®—æ³•
- å³é”®èœå•é›†æˆï¼Œæ–¹ä¾¿å¿«é€Ÿè®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
- ç®€æ´çš„å›¾å½¢ç•Œé¢ï¼Œæ”¯æŒå¤åˆ¶åˆ°å‰ªè´´æ¿
- æ”¯æŒå¤šæ–‡ä»¶åŒæ—¶å¤„ç†

## ğŸ“¦ ä¸‹è½½

- **HashCalculator-v{0}.zip** - å®Œæ•´å®‰è£…åŒ…
  - åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶ã€å®‰è£…è¯´æ˜å’Œæ³¨å†Œæ–‡ä»¶
  - æ–‡ä»¶å¤§å°ï¼šçº¦ {1} KB
  - SHA256ï¼š`{2}`
  - MD5ï¼š`{3}`

## ğŸš€ å®‰è£…è¯´æ˜

1. ä¸‹è½½ `HashCalculator-v{0}.zip` æ–‡ä»¶
2. è§£å‹åˆ°ä»»æ„ç›®å½•ï¼ˆå»ºè®®ï¼š`C:\Program Files\HashCalculator`ï¼‰
3. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ `register.reg` æ³¨å†Œå³é”®èœå•
4. é‡å¯æ–‡ä»¶èµ„æºç®¡ç†å™¨æˆ–é‡æ–°ç™»å½•

## ğŸ“‹ ä½¿ç”¨è¯´æ˜

1. åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­ï¼Œå³é”®å•å‡»ä»»æ„æ–‡ä»¶
2. åœ¨å³é”®èœå•ä¸­é€‰æ‹©"æ–‡ä»¶MD5å’ŒSHA1"
3. åœ¨å¼¹å‡ºçš„çª—å£ä¸­æŸ¥çœ‹æ–‡ä»¶çš„å“ˆå¸Œå€¼
4. ç‚¹å‡»"å¤åˆ¶"æŒ‰é’®å¯å°†ä¿¡æ¯å¤åˆ¶åˆ°å‰ªè´´æ¿

## ğŸ”§ ç³»ç»Ÿè¦æ±‚

- Windows 7 æˆ–æ›´é«˜ç‰ˆæœ¬
- Visual C++ Redistributableï¼ˆé€šå¸¸ç³»ç»Ÿå·²å®‰è£…ï¼‰
- ç®¡ç†å‘˜æƒé™ï¼ˆä»…ç”¨äºæ³¨å†Œå³é”®èœå•ï¼‰

## ğŸ› é—®é¢˜åé¦ˆ

å¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜æˆ–æœ‰å»ºè®®ï¼Œè¯·åœ¨ [Issues](https://github.com/{4}/issues) é¡µé¢æäº¤åé¦ˆã€‚

---

**æ³¨æ„**ï¼šè¯·éªŒè¯ä¸‹è½½æ–‡ä»¶çš„æ ¡éªŒå’Œä»¥ç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§ã€‚
'@ -f $version, $fileSize, $sha256, $md5, ${{ github.repository }}
        $releaseNotes | Out-File -FilePath "release/RELEASE_NOTES.md" -Encoding UTF8
        
        # åˆ›å»ºZIPåŒ…
        Compress-Archive -Path "release\*" -DestinationPath "HashCalculator-v$version.zip" -Force
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        Get-ChildItem "HashCalculator-v$version.zip" | Format-Table Name, Length, LastWriteTime

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          HashCalculator-v${{ github.ref_name }}.zip
          HashCalculator.exe.sha256
          HashCalculator.exe.md5
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
